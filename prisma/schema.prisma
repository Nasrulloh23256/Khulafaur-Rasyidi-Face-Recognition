generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  TEACHER
}

enum Gender {
  MALE
  FEMALE
}

enum SemesterName {
  GANJIL
  GENAP
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  SICK
  PERMIT
}

model User {
  id           String   @id @default(cuid())
  name         String
  email        String   @unique
  passwordHash String
  role         Role     @default(ADMIN)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  teacher     Teacher?
  attendances Attendance[] @relation("AttendanceCreatedBy")
}

model Teacher {
  id        String   @id @default(cuid())
  userId    String?  @unique
  fullName  String
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User?   @relation(fields: [userId], references: [id])
  classes Class[] @relation("HomeroomTeacher")
}

model AcademicYear {
  id        String   @id @default(cuid())
  name      String
  startDate DateTime
  endDate   DateTime
  isActive  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  semesters Semester[]
  classes   Class[]
}

model Semester {
  id             String       @id @default(cuid())
  academicYearId String
  name           SemesterName
  startDate      DateTime
  endDate        DateTime
  isActive       Boolean      @default(false)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  academicYear AcademicYear @relation(fields: [academicYearId], references: [id])
  classes      Class[]

  @@index([academicYearId])
}

model Class {
  id               String   @id @default(cuid())
  name             String
  academicYearId   String
  semesterId       String
  homeroomTeacherId String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id])
  semester       Semester     @relation(fields: [semesterId], references: [id])
  homeroomTeacher Teacher?     @relation("HomeroomTeacher", fields: [homeroomTeacherId], references: [id])
  students       Student[]
  attendances    Attendance[]

  @@unique([name, academicYearId, semesterId])
  @@index([academicYearId, semesterId])
}

model Student {
  id            String   @id @default(cuid())
  studentNumber String?  @unique
  fullName      String
  gender        Gender
  birthDate     DateTime?
  guardianName  String?
  guardianPhone String?
  classId       String?
  faceEmbedding Json?
  faceImageUrl  String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  class       Class?       @relation(fields: [classId], references: [id])
  attendances Attendance[]

  @@index([classId])
}

model Attendance {
  id          String           @id @default(cuid())
  studentId   String
  classId     String?
  date        DateTime
  status      AttendanceStatus
  checkInTime DateTime?
  notes       String?
  createdById String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  student   Student @relation(fields: [studentId], references: [id])
  class     Class?  @relation(fields: [classId], references: [id])
  createdBy User?   @relation("AttendanceCreatedBy", fields: [createdById], references: [id])

  @@unique([studentId, date])
  @@index([classId, date])
  @@index([studentId, date])
}
